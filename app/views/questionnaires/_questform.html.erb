<ul class="survey-content" >
<% @categories.each do |c| %>
	<li class="category" data-categoryid="<%= c.id %>" id="category-<%= c.id %>">
		<div class="category-bar" >
			<!-- , :html => {:multipart => true} -->
			<div class="category-name">
			<%= form_for c, url: questionnaire_category_path(@questionnaire, c),
						remote: true do |f| %>
				<%= f.text_field :name %>
			<% end %>
			</div>

			<div class="toolbar">
				<ul>
					<li><a href="#" class="edit-btn">
						<%= image_tag("edit-50.png", :alt => "Edit button") %>
					</a></li>
					<li><a href="#" class="delete-cat-btn" data-category-id="<%= c.id %>">
						<%= image_tag("delete.png", :alt => "Delete button") %>
					</a></li>
				</ul>
			</div>

			<div class="category-content">
				<div class="category-text-holder">
					<label>Kategoritext</label>
					<%= form_for c, url: questionnaire_category_path(@questionnaire, c),
							remote: true do |f| %>

						<%= f.text_area :description %>
					<% end %>
				</div>

				<div class="category-image-holder">
					<!-- A form for the image upload  -->
					<%= form_for c, :url => { :controller => "categories", :action => :uploadImage }, :html => { :method => :post,
						:class => 'catImgUploadForm', :multipart => true } do |f| %>

						<%= f.hidden_field :id, :value => c.id %>

						<%= f.label :category_image, 'Bild' %>
						<%= file_field_tag 'category_image' %>
					<% end %>

					<% if c.image %>
						<% if c.image != 0 %>
						<% @catImg = MediaFile.find(c.image) %>

						<img src="/uploads/<%= @catImg.ref %>" alt="Bild för kategori " class="catImg"/>
						<% end %>
					<% end %>
				</div>

				<div class="category-audio-holder">
					<div class="categoryAudioForm">
						<%= form_for c, :url => { :controller => "categories", :action => :uploadAudio },
						:html => { :method => :post, :class => 'catAudioUploadForm',
						:multipart => true } do |f| %>

						<%= f.hidden_field :id, :value => c.id %>

						<%= f.label :category_audio, 'Ljud' %>
						<%= file_field_tag 'category_audio' %>

						<% end %>
					</div>

					<% if c.audio %>
						<% @catAud = MediaFile.find(c.audio) %>
						<audio controls="controls" class="audioPlayer" src="/uploads/<%= @catAud.ref %>">
						</audio>
					<% end %>
				</div>
			</div>
		</div>

		<ul class="category-questions" >
		<% catquest = @questions.where(category_id: c.id) %>

		<% #= render plain: @catquest.inspect %>
		<% # @questions.where(category_id: c.id).each %>
		<% @cat = @categories.where(id: c.id) %>

		<% catquest.each do |q| %>
			<li class="question-bar" data-questionid="<%= q.id %>"
				id="question-bar-<%= q.id %>">

				<div class="question-name">
					<%= form_for q, url: questionnaire_category_question_path(@questionnaire, c.id, q),
						remote: true, :html => {:multipart => true} do |f| %>
						<!-- The questions name  -->
						<%= f.text_field :name %>
					<% end %>

					<div class="drag-indicator"></div>
				</div>
				<!-- Content for other stuff -->
				<div class="toolbar">
					<ul>
						<li><a href="#" class="edit-btn">
							<%= image_tag("edit-50.png", :alt => "Edit button") %>
						</a></li>
						<li><a href="#" class="delete-btn" data-question-id="<%= q.id %>">
							<%= image_tag("delete.png", :alt => "Delete button") %>
						</a></li>
					</ul>
				</div>

				<div class="question-content">
					<div class="questionText">
						<label>Frågetext</label>
						<%= form_for q, url: questionnaire_category_question_path(@questionnaire, c.id, q),
			remote: true, :html => {:multipart => true} do |f| %>

							<p>
								<%= f.text_area :text %>
							</p>

						<% end %>
					</div>

					<div class="questionImg">
						<div class="questionImgForm">
							<%= form_for q, :url => { :controller => "questions", :action => :uploadImage }, :html => { :method => :post, :class => 'imgUploadForm', :multipart => true } do |f| %>

								<%= f.hidden_field :id, :value => q.id %>
								<%= f.label :image, "Bild" %>
								<%= file_field_tag 'question_image' %>

							<% end %>
						</div>

						<div class="questionImgWrapper">
							<% if q.question_image %>
								<% imgFile = MediaFile.find(q.question_image) %>
								<% if imgFile  %>
									<img src="/uploads/<%= imgFile.ref%>" >
								<% end %>
							<% end %>
						</div>
					</div>

					<div class="questionAudio">
						<div class="questionAudioForm">
							<%= form_for q, :url => { :controller => "questions", :action => :uploadAudio },
							:html => { :method => :post, :class => 'audioUploadForm',
							:multipart => true } do |f| %>

							<%= f.hidden_field :id, :value => q.id %>

							<%= f.label :audio, "Ljud" %>
							<%= file_field_tag 'question_audio' %>

						<% end %>
						</div>

						<div class="questionAudioPlayer">
							<% if q.question_audio %>
							<% audFile = MediaFile.find(q.question_audio) %>
							<audio controls="controls" src="/uploads/<%= audFile.ref %>"></audio>
							<% end %>
						</div>
					</div>

					<div class="questionOptions">
						<label>Svarsalternativ</label>
						<div class = "questionOptionsForm">
							<%= form_for q, url: questionnaire_category_question_path(@questionnaire, c.id, q),
				remote: true, :html => {:multipart => true} do |f| %>
							<%=
								collection_select(:question, :response_id, @response_options, :id, :name, {prompt:true, :selected => q.response_id}, {:class => 'response_option_select'} )
							%>
					</div>

						<% if q.response_id %>
							<div class="responseOptions">
								<ul>
								<%
									rOpts = ResponseOption.find(q.response_id)
								%>
								</ul>
							</div>

							<% end %>
						<% end %>

						<p>
							<input type="button" value="Redigera svarsalternativ" class="editRespOption">
						</p>
					</div>
				</div>
			</li>
		<% end %>

		<li>
			<p>
				<button class="addQuestionToCategory" data-categoryid="<%=c.id %>">
				Lägg till fråga
				</button>
			</p>
		</li>

		</ul>
	</li>
<!-- End of the categories loop -->
<% end %>

</ul>

<ul>
	<li>
		<p>
			<button class="addCategory">Lägg till kategori</button>
		</p>
	</li>
</ul>

<!-- A little form for adding new response options -->
<div id="editRespOptForm">
	<div id="editRespContent">
		<h2>Svarsalternativ</h2>
		<ul>
			<li>
				<a href="#" class="closeRespPopup">
					<%= image_tag("close_button.png", :alt => "Close button") %>
				</a>
			</li>
		</ul>

		<form>
			<select id="respOptionsEditDropdown">
				<option value="0">Välj ett svarsalternativ</option>
			</select>

			<input type="button" value="Ny svarsuppsättning" class="newResponseOptionSet" />
		</form>

		<div id="respEditDetailed">

		</div>
	</div>
</div>

<!-- ONLY TEMPLATE STUFF -->
<!-- Templates for HTML -->
<script type="text/template" id="newQuestionFormTemp">
	<li class="question-bar" data-questionid="[%= id %]" id="question-bar-[%= id %]">
		<div class="question-name">
			<form accept-charset="UTF-8" action="/questionnaires/[%= questid %]/categories/[%= category_id %]/questions/[%= id%]"
				class="edit_question" data-remote="true" enctype="multipart/form-data"
				id="edit_question_[%= id %]" method="post">
				<div style="display:none"><input name="_method" type="hidden" value="patch">
				<input name="utf8" type="hidden" value="✓"><input name="_method" type="hidden" value="patch"></div>
				<input type="text" name="question[name]" value="" placeholder="(fråga)">

				<div class="drag-indicator"></div>
			</form>
		</div>

		<div class="toolbar" style="display: inline-block;">
			<ul>
				<li><a href="#" class="edit-btn">
					<img alt="Edit button" src="/assets/edit-50.png">
				</a></li>
				<li><a href="#" class="delete-btn" data-question-id="[%= id %]">
					<img alt="Delete button" src="/assets/delete.png">
				</a></li>
			</ul>
		</div>

		<div class="question-content">
			<div class="questionText">
				<label>Frågetext</label>
				<form accept-charset="UTF-8" action="/questionnaires/[%= questid %]/categories/[%= category_id %]/questions/[%= id %]" class="edit_question" data-remote="true" enctype="multipart/form-data" id="edit_question_[%= id %]" method="post"><div style="display:none"><input name="utf8" type="hidden" value="✓"><input name="_method" type="hidden" value="patch"></div>

				<p>
					<textarea id="question_text" name="question[text]" placeholder="Skriv här"></textarea>
				</p>

				<!-- <input name="commit" type="submit" value="Spara"> -->
				</form>
			</div>

			<div class="questionImgWrapper">
			</div>

			<div class="questionImgForm">
				<form accept-charset="UTF-8" action="/questions/uploadImage" class="imgUploadForm" enctype="multipart/form-data" id="edit_question_[%= id %]" method="post"><div style="display:none"><input name="utf8" type="hidden" value="✓"></div>

					<input id="question_id" name="question[id]" type="hidden" value="[%= id %]">

					<label for="question_image">Bild</label>
					<input id="question_image" name="question_image" type="file">
				</form>
			</div>

			<div class="questionAudio">
				<div class="questionAudioPlayer">

				</div>

				<div class="questionAudioForm">
					<form accept-charset="UTF-8" action="/questions/uploadAudio"
					class="audioUploadForm" enctype="multipart/form-data" id="edit_question_[%= id %]" method="post">
						<div style="display:none">
						<input name="utf8" type="hidden" value="✓">
						</div>

						<input id="question_id" name="question[id]" type="hidden" value="[%= id %]">

						<label for="question_audio">Ljud</label>
						<input id="question_audio" name="question_audio" type="file">

					</form>
				</div>
			</div>
			<p>
				<label>Svarsalternativ</label>
			</p>

			<form accept-charset="UTF-8" action="/questionnaires/[%= questid%]/categories/[%= category_id %]/questions/[%= id %]" class="edit_question" data-remote="true" enctype="multipart/form-data" id="edit_question_[%= id %]" method="post">
				<div style="display:none">
					<input name="utf8" type="hidden" value="✓">
					<input name="_method" type="hidden" value="patch">
				</div>


				<select class="response_option_select" id="question_response_id" name="question[response_id]">
					[% _.each(response_options, function (option) { %]
						<option value="[%= option.id %]">[%= option.name %]</option>
					[% }); %]
				</select>

				<input name="commit" type="submit" value="Spara">
				<p></p>
				<div class="responseOptions">
					<ul>
					</ul>
				</div>
				<p>
					<input type="button" value="Redigera svarsalternativ" class="editRespOption">
				</p>
			</form>

			<p>
				<input type="button" value="Nytt svarsalternativ" id="newRespOption">
			</p>
		</div>
	</li>
</script>


<!-- Template for the edit-view of the response options -->
<script type="text/template" id="editResponseOptionsForm">
	<form accept-charset="UTF-8" action="/response_options/edit" class="edit_response_option"
	id="edit_response_option" method="post" enctype="multipart/form-data">
		<table>
			<div style="display: none;"><input type="hidden" name="response_option_id" class="response_option_id" value="[%= id %]"></div>
			<p>
				<input class="responseOptionName" type="text" name="response_option_name" value="[%= name %]" >
				<div class="responseOptionAvailability">
					<input type="checkbox" name="response_option_availability" value="[%= id %]">
					<p>Gör denna uppsättning tillgänglig för andra frågor</p>
				</div>
			</p>

			<thead>
				<tr>
					<th>Svarsvärde </th>
					<th>Svarstext</th>
					<th>Ljudfil</th>
					<th>Alternativ</th>
				</tr>
			</thead>

			<tbody id="editResponseOptionTBody">
			[% _.each(options, function (opt) { %]
				<tr class="respOptInput">
					<input type="hidden" value="[%=opt.id %]" name="respValItemId[]">
					<td><input type="text" value="[%= opt.value %]" name="respVal[]" class="small" onKeyPress="return numbersonly(this, event)"></td>
					<td><input type="text" value="[%=opt.label %]" name="respLbl[]" ></td>
					<td><input type="file" name="respAudio[]" ></td>
					<td ><a href="#" data-item-id="[%= opt.id %]">Radera</a></td>
				</tr>
			[% }); %]
			</tbody>
		</table>

		<p>
			<input type="button" class="deleteResponseOptionSet" value="Radera" >
			<input type="button" class="addRespOption" value="Lägg till alternativ" >
			<input type="submit" value="Spara" >
		</p>
	</form>
</script>

<!-- Template for new response option -->
<script type="text/template" id="newResponseOptionTemp">
	<tr class="respOptInput">
		<input type="hidden" name="respValItemId[]" value="[%=id %]" > </td>
		<td><input type="text" placeholder="Värde" name="respVal[]" class="small" > </td>
		<td><input type="text" placeholder="Svarstext" name="respLbl[]" > </td>
		<td><input type="file" name="respAudio[]" > </td>
		<td></td>
	</tr>
</script>

<!-- Template for a new category -->
<script type="text/template" id="newCategoryTmp">
	<li class="category" data-categoryid="[%= id %]" id="category-[%= id %]">
		<div class="category-bar">
			<form accept-charset="UTF-8" action="/questionnaires/[%= questionnaire_id_id %]/categories/[%= id %]" class="edit_category" data-remote="true" id="edit_category_[%= id %]" method="post">
			<div style="display:none">
				<input name="utf8" type="hidden" value="✓">
				<input name="_method" type="hidden" value="patch">
			</div>

			<input id="category_name" name="category[name]" type="text" value="Ny kategori" placeholder="(kategori)">

			</form>

			<div class="toolbar" style="display: inline-block;">
				<ul>
					<li><a href="#" class="edit-btn">
						<img alt="Edit button" src="/assets/edit-50.png">
					</a></li>
					<li><a href="#" class="delete-cat-btn" data-category-id="[%= id %]">
						<img alt="Delete button" src="/assets/delete.png">
					</a></li>

				</ul>
			</div>

			<div class="category-content">
				<div class="category-text-holder">
					<label>Kategoritext</label>
					<form accept-charset="UTF-8" action="/questionnaires/[%= questionnaire_id_id %]/categories/[%= id %]" class="edit_category" data-remote="true" id="edit_category_[%= id %]" method="post">
						<div style="display:none">
							<input name="utf8" type="hidden" value="✓">
							<input name="_method" type="hidden" value="patch">
						</div>

						<textarea id="category_description" name="category[description]" placeholder="Skriv här"></textarea>
						<!-- <input name="commit" type="submit" value="Spara"> -->
					</form>
				</div>

				<div class="category-image-holder">

					<!-- A form for the image upload  -->
					<form accept-charset="UTF-8" action="/categories/uploadImage" class="catImgUploadForm" enctype="multipart/form-data" id="edit_category_[%= id %]" method="post">
						<div style="display:none">
							<input name="utf8" type="hidden" value="✓">
						</div>

						<input id="category_id" name="category[id]" type="hidden" value="[%= id %]">

						<label for="category_category_image">Bild</label>
						<input id="category_image" name="category_image" type="file">
						<!-- <input name="commit" type="submit" value="Ladda upp"> -->

					</form>
				</div>

				<div class="category-audio-holder">
					<div class="categoryAudioForm">
						<form accept-charset="UTF-8" action="/categories/uploadAudio" class="catAudioUploadForm" enctype="multipart/form-data" id="edit_category_980190980" method="post">
							<div style="display:none">
								<input name="utf8" type="hidden" value="✓">
								<input name="authenticity_token" type="hidden" value="PxbM7sHpVN4B4iujjIRtvoRam3HnQ9W6X7samU90wh0=">
							</div>

							<input id="category_id" name="category[id]" type="hidden" value="[%= id %]">

							<label for="category_category_audio">Ljud</label>
							<input id="category_audio" name="category_audio" type="file">

						</form>
					</div>
				</div>
			</div>
		</div>

		<ul class="category-questions ui-sortable">
			<li>
				<p>
					<button class="addQuestionToCategory" data-categoryid="[%= id %]">
					Lägg till fråga
					</button>
				</p>
			</li>
		</ul>
	</li>
</script>
